<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Tracker - ระบบติดตามคนไข้</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 10px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: #007bff;
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 3px solid #007bff;
        }

        /* Compact Entry Card */
        .compact-entry-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
            border: 2px solid #007bff;
            max-width: 950px;
            margin: 0 auto 25px auto;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-title {
            font-size: 1.6rem;
            color: #007bff;
            margin: 0;
        }

        .btn-save-primary {
            background: #007bff;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            min-width: 140px;
        }

        .btn-save-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Date/Time Row */
        .datetime-row {
            display: flex;
            gap: 20px;
            margin-bottom: 18px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .datetime-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .datetime-label {
            font-size: 18px;
        }

        .datetime-input {
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 16px;
            background: white;
            color: #666;
            min-width: 140px;
        }

        /* Field Rows - Clean Grid Layout */
        .field-row {
            display: grid;
            grid-template-columns: 120px 1fr;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
        }

        .field-row.full-width {
            grid-template-columns: 1fr;
        }

        .field-row.two-column {
            grid-template-columns: 80px 200px 80px 1fr;
            gap: 15px;
        }

        .field-row.fee-row {
            grid-template-columns: 120px 1fr;
        }

        .field-label {
            font-weight: bold;
            color: #333;
            font-size: 16px;
            text-align: left;
            margin: 0;
        }

        .field-label-small {
            font-weight: bold;
            color: #666;
            font-size: 14px;
            text-align: left;
            margin: 0;
        }

        /* Input Styles */
        .field-input-large {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            transition: border-color 0.3s;
            min-height: 50px;
        }

        .field-input-medium {
            width: 280px;
            padding: 14px 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            transition: border-color 0.3s;
            min-height: 50px;
        }

        .field-input-small {
            width: 120px;
            padding: 12px 14px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
            min-height: 44px;
        }

        .field-input-name {
            width: 100%;
            max-width: 400px;
            padding: 14px 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            transition: border-color 0.3s;
            min-height: 50px;
        }

        .field-input-large:focus,
        .field-input-medium:focus,
        .field-input-small:focus,
        .field-input-name:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.1);
        }

        /* Fee Row */
        .fee-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .fee-buttons-compact {
            display: flex;
            gap: 8px;
        }

        .fee-btn-compact {
            padding: 10px 18px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 60px;
            min-height: 44px;
        }

        .fee-btn-compact:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .fee-btn-compact.active {
            background: #17a2b8;
            box-shadow: 0 0 0 2px rgba(23,162,184,0.3);
        }

        .fee-input {
            width: 120px;
            padding: 12px 14px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 18px;
            text-align: center;
            min-height: 44px;
        }

        .fee-input:focus {
            outline: none;
            border-color: #007bff;
        }

        /* Optional Groups */
        .optional-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Notes Input */
        .notes-input {
            flex: 1;
            padding: 12px 14px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            resize: vertical;
            min-height: 44px;
        }

        .notes-input:focus {
            outline: none;
            border-color: #007bff;
        }

        .btn-clear {
            background: #ffc107;
            color: #333;
            border: none;
            padding: 12px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            min-height: 44px;
        }

        .btn-clear:hover {
            background: #e0a800;
        }

        /* Fee Buttons */
        .fee-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .fee-btn {
            padding: 8px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .fee-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .fee-btn.active {
            background: #17a2b8;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 150px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
        }

        /* Dashboard Cards */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .dashboard-card.revenue {
            background: linear-gradient(135deg, #43e97b, #38f9d7);
        }

        .dashboard-card.average {
            background: linear-gradient(135deg, #fa709a, #fee140);
        }

        .dashboard-card.pending {
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
        }

        .dashboard-card h3 {
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .dashboard-card .value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* Patient List */
        .patient-list {
            margin-top: 20px;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .patient-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .patient-table th {
            background: #007bff;
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: bold;
        }

        .patient-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
        }

        .patient-table tr:hover {
            background: #f8f9fa;
        }

        .patient-table tr.today {
            background: #e8f5e8;
        }

        .action-btn {
            padding: 5px 10px;
            margin: 0 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .edit-btn {
            background: #ffc107;
            color: #212529;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        /* Export Section */
        .export-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Status Colors */
        .status-paid { color: #28a745; font-weight: bold; }
        .status-pending { color: #ffc107; font-weight: bold; }
        .status-installment { color: #17a2b8; font-weight: bold; }

        /* Action Bar */
        .action-bar {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .btn-save-main {
            background: #007bff;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            min-width: 160px;
        }

        .btn-save-main:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-clear-main {
            background: #ffc107;
            color: #333;
            border: none;
            padding: 16px 32px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            min-width: 160px;
        }

        .btn-clear-main:hover {
            background: #e0a800;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 5px;
            }

            .compact-entry-card {
                margin: 0 5px 20px 5px;
                padding: 20px;
                max-width: none;
                width: 95%;
            }
            
            .card-header {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .btn-save-primary {
                width: 100%;
                padding: 16px;
                font-size: 18px;
            }
            
            .field-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .field-row.two-column {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .field-row.fee-row {
                grid-template-columns: 1fr;
            }
            
            .field-label,
            .field-label-small {
                margin-bottom: 5px;
                font-size: 16px;
            }
            
            .field-input-medium,
            .field-input-large,
            .field-input-name,
            .field-input-small {
                width: 100%;
                max-width: none;
            }
            
            .fee-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .fee-buttons-compact {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .fee-input {
                width: 100%;
                margin-top: 10px;
            }
            
            .datetime-row {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .datetime-group {
                width: 100%;
            }
            
            .datetime-input {
                width: 100%;
                min-width: auto;
            }
            
            .notes-input {
                min-height: 60px;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .action-bar {
                flex-direction: column;
                gap: 12px;
            }
            
            .btn-save-main,
            .btn-clear-main {
                width: 100%;
                padding: 18px;
                font-size: 18px;
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🦷 Cue's Patient Tracker</h1>
            <p>ระบบติดตามคนไข้สำหรับหมอคิว</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('entry')">📝 ลงข้อมูล</button>
            <button class="tab" onclick="showTab('list')">📋 รายการคนไข้</button>
            <button class="tab" onclick="showTab('dashboard')">📊 Dashboard</button>
            <button class="tab" onclick="showTab('export')">📁 Export/Import</button>
            <button class="tab" onclick="showTab('settings')">⚙️ Settings</button>
        </div>

        <!-- Patient Entry Tab -->
        <div id="entry" class="tab-content active">
            <!-- Compact Entry Card -->
            <div class="compact-entry-card">
                <!-- Header with Title -->
                <div class="card-header">
                    <h2 class="card-title">🦷 ลงข้อมูลคนไข้ใหม่</h2>
                </div>
                
                <!-- Auto Date/Time Row -->
                <div class="datetime-row">
                    <div class="datetime-group">
                        <span class="datetime-label">📅</span>
                        <input type="date" id="patientDate" class="datetime-input" required>
                    </div>
                    <div class="datetime-group">
                        <span class="datetime-label">⏰</span>
                        <input type="time" id="patientTime" class="datetime-input" required>
                    </div>
                </div>
                
                <!-- Treatment Row -->
                <div class="field-row">
                    <label class="field-label">🏥 การรักษา:</label>
                    <select id="treatmentType" class="field-input-large" required>
                        <option value="">เลือกประเภทการรักษา...</option>
                        <option value="จัดฟัน (Braces)">จัดฟัน (Braces)</option>
                        <option value="ถอนฟัน (Extraction)">ถอนฟัน (Extraction)</option>
                        <option value="ตรวจฟัน (Checkup)">ตรวจฟัน (Checkup)</option>
                        <option value="ปรับลวด (Adjustment)">ปรับลวด (Adjustment)</option>
                        <option value="รีเทนเนอร์ (Retainer)">รีเทนเนอร์ (Retainer)</option>
                        <option value="ขูดหินปูน (Scaling)">ขูดหินปูน (Scaling)</option>
                        <option value="อุดฟัน (Filling)">อุดฟัน (Filling)</option>
                        <option value="รากเทียม (Implant)">รากเทียม (Implant)</option>
                        <option value="ฟอกสีฟัน (Whitening)">ฟอกสีฟัน (Whitening)</option>
                        <option value="อื่นๆ (Other)">อื่นๆ (Other)</option>
                    </select>
                </div>
                
                <!-- Fee Row -->
                <div class="field-row">
                    <label class="field-label">💰 ค่ารักษา:</label>
                    <div class="fee-row">
                        <div class="fee-buttons-compact" id="feeButtonsContainer">
                            <button type="button" class="fee-btn-compact" onclick="setFee(1000)">1K</button>
                            <button type="button" class="fee-btn-compact" onclick="setFee(1500)">1.5K</button>
                            <button type="button" class="fee-btn-compact" onclick="setFee(2000)">2K</button>
                            <button type="button" class="fee-btn-compact" onclick="setFee(3000)">3K</button>
                        </div>
                        <input type="number" id="patientFee" class="fee-input" placeholder="฿" min="0">
                    </div>
                </div>
                
                <!-- Payment Status Row -->
                <div class="field-row">
                    <label class="field-label">💳 สถานะ:</label>
                    <select id="paymentStatus" class="field-input-medium" required>
                        <option value="ชำระแล้ว (Paid)">ชำระแล้ว</option>
                        <option value="รอชำระ (Pending)">รอชำระ</option>
                        <option value="ผ่อนชำระ (Installment)">ผ่อนชำระ</option>
                    </select>
                </div>
                
                <!-- Optional Info Row -->
                <div class="field-row two-column">
                    <label class="field-label-small">DN:</label>
                    <input type="text" id="patientDN" class="field-input-small" placeholder="2024-001">
                    <label class="field-label-small">👤 ชื่อ:</label>
                    <input type="text" id="patientName" class="field-input-name" placeholder="ชื่อคนไข้">
                </div>
                
                <!-- Notes Row -->
                <div class="field-row">
                    <label class="field-label">📝 หมายเหตุ:</label>
                    <textarea id="patientNotes" class="notes-input" placeholder="หมายเหตุ..." rows="1"></textarea>
                </div>
                
                <!-- Bottom Action Bar -->
                <div class="action-bar">
                    <button type="button" class="btn-save-main" onclick="savePatient()">💾 บันทึก</button>
                    <button type="button" class="btn-clear-main" onclick="clearForm()">🔄 ล้างฟอร์ม</button>
                </div>
            </div>
            
            <!-- Today's Summary -->
            <div class="dashboard" id="todaySummary">
                <div class="dashboard-card">
                    <h3>คนไข้วันนี้</h3>
                    <div class="value" id="todayCount">0</div>
                    <div>ราย</div>
                </div>
                
                <div class="dashboard-card revenue">
                    <h3>รายได้วันนี้</h3>
                    <div class="value" id="todayRevenue">฿0</div>
                </div>
                
                <div class="dashboard-card average">
                    <h3>เฉลี่ย/คน</h3>
                    <div class="value" id="todayAverage">฿0</div>
                </div>
                
                <div class="dashboard-card pending">
                    <h3>รอชำระ</h3>
                    <div class="value" id="todayPending">฿0</div>
                </div>
            </div>
        </div>

        <!-- Patient List Tab -->
        <div id="list" class="tab-content">
            <h2 class="section-title">รายการคนไข้ทั้งหมด</h2>
            
            <input type="text" class="search-box" placeholder="🔍 ค้นหาคนไข้..." onkeyup="searchPatients(this.value)">
            
            <div class="patient-list">
                <table class="patient-table" id="patientTable">
                    <thead>
                        <tr>
                            <th>วันที่</th>
                            <th>เวลา</th>
                            <th>DN</th>
                            <th>ชื่อ</th>
                            <th>การรักษา</th>
                            <th>ค่ารักษา</th>
                            <th>สถานะ</th>
                            <th>หมายเหตุ</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="patientTableBody">
                        <!-- Patients will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <h2 class="section-title">Dashboard & Analytics</h2>
            
            <div class="dashboard" id="mainDashboard">
                <!-- Dashboard cards will be populated here -->
            </div>
        </div>

        <!-- Export/Import Tab -->
        <div id="export" class="tab-content">
            <h2 class="section-title">Export & Import Data</h2>
            
            <div class="export-section">
                <p><strong>Export ข้อมูล:</strong></p>
                <div class="export-buttons">
                    <button class="btn btn-primary" onclick="exportToday()">📊 Export วันนี้</button>
                    <button class="btn btn-primary" onclick="exportAll()">📈 Export ทั้งหมด</button>
                    <button class="btn btn-secondary" onclick="clearAllData()">🗑️ ล้างข้อมูลทั้งหมด</button>
                </div>
                
                <hr style="margin: 20px 0;">
                
                <p><strong>Import ข้อมูล:</strong></p>
                <input type="file" id="importFile" accept=".json,.csv" style="margin: 10px 0;">
                <button class="btn btn-secondary" onclick="importData()">📁 Import Data</button>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <h2 class="section-title">Settings - การตั้งค่า</h2>
            
            <!-- Treatment Types Editor -->
            <div class="entry-form" style="margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px; color: #007bff;">📋 ประเภทการรักษา (Treatment Types)</h3>
                <div class="form-group">
                    <label>แก้ไขประเภทการรักษา (หนึ่งรายการต่อบรรทัด):</label>
                    <textarea id="treatmentTypesEditor" rows="10" style="width: 100%; padding: 10px; font-family: monospace;">จัดฟัน (Braces)
ถอนฟัน (Extraction)
ตรวจฟัน (Checkup)
ปรับลวด (Adjustment)
รีเทนเนอร์ (Retainer)
ขูดหินปูน (Scaling)
อุดฟัน (Filling)
รากเทียม (Implant)
ฟอกสีฟัน (Whitening)
อื่นๆ (Other)</textarea>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="saveTreatmentTypes()">💾 บันทึกประเภทการรักษา</button>
                    <button class="btn btn-secondary" onclick="resetTreatmentTypes()">🔄 รีเซ็ตเป็นค่าเริ่มต้น</button>
                </div>
            </div>

            <!-- Fee Buttons Editor -->
            <div class="entry-form">
                <h3 style="margin-bottom: 15px; color: #007bff;">💰 ปุ่มค่ารักษา (Quick Fee Buttons)</h3>
                <div class="form-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="form-group">
                        <label>ปุ่มที่ 1 (฿):</label>
                        <input type="number" id="feeButton1" value="1000" min="0">
                    </div>
                    <div class="form-group">
                        <label>ปุ่มที่ 2 (฿):</label>
                        <input type="number" id="feeButton2" value="1500" min="0">
                    </div>
                    <div class="form-group">
                        <label>ปุ่มที่ 3 (฿):</label>
                        <input type="number" id="feeButton3" value="2000" min="0">
                    </div>
                    <div class="form-group">
                        <label>ปุ่มที่ 4 (฿):</label>
                        <input type="number" id="feeButton4" value="3000" min="0">
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="saveFeeButtons()">💾 บันทึกปุ่มค่ารักษา</button>
                    <button class="btn btn-secondary" onclick="resetFeeButtons()">🔄 รีเซ็ตเป็นค่าเริ่มต้น</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize app
        let patients = JSON.parse(localStorage.getItem('patients')) || [];
        let editingId = null;
        
        // Default settings
        const defaultTreatmentTypes = [
            'จัดฟัน (Braces)',
            'ถอนฟัน (Extraction)',
            'ตรวจฟัน (Checkup)',
            'ปรับลวด (Adjustment)',
            'รีเทนเนอร์ (Retainer)',
            'ขูดหินปูน (Scaling)',
            'อุดฟัน (Filling)',
            'รากเทียม (Implant)',
            'ฟอกสีฟัน (Whitening)',
            'อื่นๆ (Other)'
        ];
        
        const defaultFeeButtons = [1000, 1500, 2000, 3000];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            updateDateTime();
            updateSummary();
            displayPatients();
            updateDashboard();
        });

        // Auto-update date and time
        function updateDateTime() {
            const now = new Date();
            document.getElementById('patientDate').value = now.toISOString().split('T')[0];
            document.getElementById('patientTime').value = now.toTimeString().slice(0,5);
        }

        // Set fee from quick buttons
        function setFee(amount) {
            document.getElementById('patientFee').value = amount;
            
            // Update button states
            document.querySelectorAll('.fee-btn-compact').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Save patient data
        function savePatient() {
            const patientData = {
                id: editingId || Date.now(),
                date: document.getElementById('patientDate').value,
                time: document.getElementById('patientTime').value,
                dn: document.getElementById('patientDN').value,
                name: document.getElementById('patientName').value,
                treatment: document.getElementById('treatmentType').value,
                fee: parseFloat(document.getElementById('patientFee').value) || 0,
                status: document.getElementById('paymentStatus').value,
                notes: document.getElementById('patientNotes').value
            };

            // Validate required fields
            if (!patientData.treatment) {
                alert('กรุณาเลือกประเภทการรักษา');
                return;
            }

            if (editingId) {
                // Update existing patient
                const index = patients.findIndex(p => p.id === editingId);
                if (index !== -1) {
                    patients[index] = patientData;
                }
                editingId = null;
            } else {
                // Add new patient
                patients.push(patientData);
            }

            // Save to localStorage
            localStorage.setItem('patients', JSON.stringify(patients));

            // Clear form and update displays
            clearForm();
            updateSummary();
            displayPatients();
            updateDashboard();

            alert('บันทึกข้อมูลเรียบร้อย!');
        }

        // Clear form
        function clearForm() {
            updateDateTime();
            document.getElementById('patientDN').value = '';
            document.getElementById('patientName').value = '';
            document.getElementById('treatmentType').value = '';
            document.getElementById('patientFee').value = '';
            document.getElementById('paymentStatus').value = 'ชำระแล้ว (Paid)';
            document.getElementById('patientNotes').value = '';
            
            // Clear fee button states
            document.querySelectorAll('.fee-btn-compact').forEach(btn => {
                btn.classList.remove('active');
            });
            
            editingId = null;
        }

        // Update today's summary
        function updateSummary() {
            const today = new Date().toISOString().split('T')[0];
            const todayPatients = patients.filter(p => p.date === today);
            
            const count = todayPatients.length;
            const revenue = todayPatients.reduce((sum, p) => sum + p.fee, 0);
            const average = count > 0 ? revenue / count : 0;
            const pending = todayPatients
                .filter(p => p.status.includes('รอชำระ'))
                .reduce((sum, p) => sum + p.fee, 0);

            document.getElementById('todayCount').textContent = count;
            document.getElementById('todayRevenue').textContent = `฿${revenue.toLocaleString()}`;
            document.getElementById('todayAverage').textContent = `฿${Math.round(average).toLocaleString()}`;
            document.getElementById('todayPending').textContent = `฿${pending.toLocaleString()}`;
        }

        // Display patients in table
        function displayPatients() {
            const tbody = document.getElementById('patientTableBody');
            const today = new Date().toISOString().split('T')[0];
            
            // Sort by date and time (newest first)
            const sortedPatients = [...patients].sort((a, b) => {
                if (a.date === b.date) {
                    return b.time.localeCompare(a.time);
                }
                return b.date.localeCompare(a.date);
            });

            tbody.innerHTML = sortedPatients.map(patient => {
                const isToday = patient.date === today;
                const statusClass = patient.status.includes('ชำระแล้ว') ? 'status-paid' : 
                                   patient.status.includes('รอชำระ') ? 'status-pending' : 'status-installment';
                
                return `
                    <tr class="${isToday ? 'today' : ''}">
                        <td>${new Date(patient.date).toLocaleDateString('th-TH')}</td>
                        <td>${patient.time}</td>
                        <td>${patient.dn || '-'}</td>
                        <td>${patient.name || '-'}</td>
                        <td>${patient.treatment}</td>
                        <td>฿${patient.fee.toLocaleString()}</td>
                        <td class="${statusClass}">${patient.status}</td>
                        <td>${patient.notes || '-'}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="editPatient(${patient.id})">แก้ไข</button>
                            <button class="action-btn delete-btn" onclick="deletePatient(${patient.id})">ลบ</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Edit patient
        function editPatient(id) {
            const patient = patients.find(p => p.id === id);
            if (!patient) return;

            // Fill form with patient data
            document.getElementById('patientDate').value = patient.date;
            document.getElementById('patientTime').value = patient.time;
            document.getElementById('patientDN').value = patient.dn;
            document.getElementById('patientName').value = patient.name;
            document.getElementById('treatmentType').value = patient.treatment;
            document.getElementById('patientFee').value = patient.fee;
            document.getElementById('paymentStatus').value = patient.status;
            document.getElementById('patientNotes').value = patient.notes;

            editingId = id;

            // Switch to entry tab
            showTab('entry');
        }

        // Delete patient
        function deletePatient(id) {
            if (confirm('ต้องการลบข้อมูลคนไข้นี้หรือไม่?')) {
                patients = patients.filter(p => p.id !== id);
                localStorage.setItem('patients', JSON.stringify(patients));
                updateSummary();
                displayPatients();
                updateDashboard();
            }
        }

        // Search patients
        function searchPatients(query) {
            const tbody = document.getElementById('patientTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        // Update dashboard
        function updateDashboard() {
            const dashboard = document.getElementById('mainDashboard');
            const today = new Date().toISOString().split('T')[0];
            const thisMonth = new Date().toISOString().slice(0, 7);
            
            const todayPatients = patients.filter(p => p.date === today);
            const monthPatients = patients.filter(p => p.date.startsWith(thisMonth));
            
            const monthRevenue = monthPatients.reduce((sum, p) => sum + p.fee, 0);
            const monthCount = monthPatients.length;
            
            dashboard.innerHTML = `
                <div class="dashboard-card">
                    <h3>คนไข้เดือนนี้</h3>
                    <div class="value">${monthCount}</div>
                    <div>ราย</div>
                </div>
                
                <div class="dashboard-card revenue">
                    <h3>รายได้เดือนนี้</h3>
                    <div class="value">฿${monthRevenue.toLocaleString()}</div>
                </div>
                
                <div class="dashboard-card average">
                    <h3>เฉลี่ยต่อวัน</h3>
                    <div class="value">${Math.round(monthCount / new Date().getDate())}</div>
                    <div>คน/วัน</div>
                </div>
                
                <div class="dashboard-card pending">
                    <h3>รวมทุกอย่าง</h3>
                    <div class="value">${patients.length}</div>
                    <div>คนไข้</div>
                </div>
            `;
        }

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Export functions
        function exportToday() {
            const today = new Date().toISOString().split('T')[0];
            const todayPatients = patients.filter(p => p.date === today);
            downloadCSV(todayPatients, `patients_${today}.csv`);
        }

        function exportAll() {
            downloadCSV(patients, 'all_patients.csv');
        }

        function downloadCSV(data, filename) {
            const headers = ['วันที่', 'เวลา', 'DN', 'ชื่อคนไข้', 'การรักษา', 'ค่ารักษา', 'สถานะ', 'หมายเหตุ'];
            const csvContent = [
                headers.join(','),
                ...data.map(p => [
                    p.date,
                    p.time,
                    p.dn || '',
                    p.name || '',
                    p.treatment,
                    p.fee,
                    p.status,
                    p.notes || ''
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        function clearAllData() {
            if (confirm('ต้องการลบข้อมูลทั้งหมดหรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้!')) {
                localStorage.removeItem('patients');
                patients = [];
                updateSummary();
                displayPatients();
                updateDashboard();
                alert('ลบข้อมูลทั้งหมดเรียบร้อย!');
            }
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('กรุณาเลือกไฟล์');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        patients = [...patients, ...importedData];
                        localStorage.setItem('patients', JSON.stringify(patients));
                        updateSummary();
                        displayPatients();
                        updateDashboard();
                        alert('Import ข้อมูลเรียบร้อย!');
                    } else {
                        alert('รูปแบบไฟล์ไม่ถูกต้อง');
                    }
                } catch (error) {
                    alert('เกิดข้อผิดพลาดในการ import ข้อมูล');
                }
            };
            reader.readAsText(file);
        }

        // Clear fee button selection when typing
        document.getElementById('patientFee').addEventListener('input', function() {
            document.querySelectorAll('.fee-btn-compact').forEach(btn => {
                btn.classList.remove('active');
            });
        });

        // ===== SETTINGS FUNCTIONS =====

        // Load settings from localStorage
        function loadSettings() {
            // Load treatment types
            const savedTreatments = localStorage.getItem('customTreatmentTypes');
            if (savedTreatments) {
                const treatments = JSON.parse(savedTreatments);
                updateTreatmentDropdown(treatments);
                document.getElementById('treatmentTypesEditor').value = treatments.join('\n');
            } else {
                updateTreatmentDropdown(defaultTreatmentTypes);
            }

            // Load fee buttons
            const savedFees = localStorage.getItem('customFeeButtons');
            if (savedFees) {
                const fees = JSON.parse(savedFees);
                updateFeeButtons(fees);
                document.getElementById('feeButton1').value = fees[0];
                document.getElementById('feeButton2').value = fees[1];
                document.getElementById('feeButton3').value = fees[2];
                document.getElementById('feeButton4').value = fees[3];
            } else {
                updateFeeButtons(defaultFeeButtons);
            }
        }

        // Update treatment dropdown
        function updateTreatmentDropdown(treatments) {
            const dropdown = document.getElementById('treatmentType');
            dropdown.innerHTML = '<option value="">เลือกการรักษา...</option>';
            
            treatments.forEach(treatment => {
                if (treatment.trim()) {
                    const option = document.createElement('option');
                    option.value = treatment.trim();
                    option.textContent = treatment.trim();
                    dropdown.appendChild(option);
                }
            });
        }

        // Update fee buttons
        function updateFeeButtons(fees) {
            const container = document.getElementById('feeButtonsContainer');
            container.innerHTML = '';
            
            fees.forEach((fee, index) => {
                if (fee > 0) {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'fee-btn-compact';
                    button.onclick = () => setFee(fee);
                    button.textContent = fee >= 1000 ? `${fee/1000}K` : fee.toString();
                    container.appendChild(button);
                }
            });
        }

        // Save treatment types
        function saveTreatmentTypes() {
            const editorContent = document.getElementById('treatmentTypesEditor').value;
            const treatments = editorContent.split('\n').map(t => t.trim()).filter(t => t);
            
            if (treatments.length === 0) {
                alert('กรุณาใส่ประเภทการรักษาอย่างน้อย 1 รายการ');
                return;
            }

            localStorage.setItem('customTreatmentTypes', JSON.stringify(treatments));
            updateTreatmentDropdown(treatments);
            alert('บันทึกประเภทการรักษาเรียบร้อย!');
        }

        // Reset treatment types to default
        function resetTreatmentTypes() {
            if (confirm('ต้องการรีเซ็ตประเภทการรักษาเป็นค่าเริ่มต้นหรือไม่?')) {
                localStorage.removeItem('customTreatmentTypes');
                updateTreatmentDropdown(defaultTreatmentTypes);
                document.getElementById('treatmentTypesEditor').value = defaultTreatmentTypes.join('\n');
                alert('รีเซ็ตประเภทการรักษาเรียบร้อย!');
            }
        }

        // Save fee buttons
        function saveFeeButtons() {
            const fees = [
                parseInt(document.getElementById('feeButton1').value) || 0,
                parseInt(document.getElementById('feeButton2').value) || 0,
                parseInt(document.getElementById('feeButton3').value) || 0,
                parseInt(document.getElementById('feeButton4').value) || 0
            ];

            const validFees = fees.filter(fee => fee > 0);
            if (validFees.length === 0) {
                alert('กรุณาใส่ค่ารักษาอย่างน้อย 1 รายการ');
                return;
            }

            localStorage.setItem('customFeeButtons', JSON.stringify(fees));
            updateFeeButtons(fees);
            alert('บันทึกปุ่มค่ารักษาเรียบร้อย!');
        }

        // Reset fee buttons to default
        function resetFeeButtons() {
            if (confirm('ต้องการรีเซ็ตปุ่มค่ารักษาเป็นค่าเริ่มต้นหรือไม่?')) {
                localStorage.removeItem('customFeeButtons');
                updateFeeButtons(defaultFeeButtons);
                document.getElementById('feeButton1').value = defaultFeeButtons[0];
                document.getElementById('feeButton2').value = defaultFeeButtons[1];
                document.getElementById('feeButton3').value = defaultFeeButtons[2];
                document.getElementById('feeButton4').value = defaultFeeButtons[3];
                alert('รีเซ็ตปุ่มค่ารักษาเรียบร้อย!');
            }
        }
    </script>
</body>
</html>